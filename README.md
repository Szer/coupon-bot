# Coupon Hub Bot

Telegram бот для управления купонами Dunnes в закрытом сообществе.

## Архитектура

- **F#/.NET 10** - основной язык и фреймворк
- **PostgreSQL** - база данных
- **Dapper** - ORM для работы с БД
- **Telegram.Bot 22.8.1** - библиотека для работы с Telegram API
- **ASP.NET Core Minimal API** - веб-сервер для webhook
- **Docker** - контейнеризация
- **GitHub Actions** - CI/CD

## Основные возможности

### Команды в личке (DM)

- **Основные (в меню):**
  - `/add` (алиас `/a`) — добавить купон через мастер (wizard)
  - `/list` (алиас `/l`, legacy алиас `/coupons`) — доступные купоны (истёкшие не показываются)
  - `/my` (алиас `/m`) — мои купоны: альбом фото (1–4) + одно сообщение с описанием, `ID:` и кнопками
  - `/stats` (алиас `/s`) — статистика пользователя
  - `/feedback` (алиас `/f`) — отправить фидбэк авторам (следующее сообщение форвардится админам)
  - `/help` — справка
- **Дополнительно (не в меню):**
  - `/take <id>` (или `/take` как алиас `/list`) — взять купон (транзакционно)
  - `/used <id>` — отметить купон как использованный
  - `/return <id>` — вернуть купон в доступные

### Правила и UX

- **Лимит взятия**: одновременно можно держать максимум **4** купона (race-safe, даже при параллельных запросах).
- **Истёкшие купоны**: не удаляются из БД, но **не показываются** в доступных и **нельзя взять** купон, если он истёк.

### Уведомления и напоминания

- **В группе**:
  - утреннее напоминание об истекающих сегодня доступных купонах
  - по понедельникам утром — статистика за последние 7 дней (кто сколько **использовал** и кто сколько **добавил**)
- **В личке**:
  - утреннее напоминание тем, у кого есть купоны в статусе `taken` старше 1 дня (одно сообщение на пользователя, даже если купонов несколько)

## Разработка

См. [README.dev.md](README.dev.md) для инструкций по локальной разработке.

## Деплой

Деплой настроен через GitHub Actions (`.github/workflows/deploy.yml`):

1. Запускает тесты
2. Применяет миграции Flyway к продакшн БД
3. Билдит Docker image для `linux/amd64`
4. Пушит в GitHub Container Registry: `ghcr.io/szer/coupon-bot`

### Требуемые Secrets

- `WIREGUARD_CONFIG` - конфигурация VPN для доступа к продакшн БД
- `DB_PROD_URL` - URL продакшн базы данных
- `DB_PROD_USERNAME` - пользователь БД
- `DB_PROD_PASSWORD` - пароль БД

### Использование образа

```bash
docker pull ghcr.io/szer/coupon-bot:latest
docker run -e BOT_TELEGRAM_TOKEN=... -e DATABASE_URL=... ghcr.io/szer/coupon-bot:latest
```

## Лицензия

MIT
