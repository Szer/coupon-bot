# Coupon Hub Bot — правила для агента

## Что это

Telegram-бот для совместного управления купонами Dunnes в закрытом сообществе. Пользователи добавляют купоны (фото + номинал + дата), берут из «доступных», отмечают «использован» или возвращают. Всё в личке, уведомления — в группу. Язык интерфейса — русский.

Стек: **F# / .NET 10**, PostgreSQL, Dapper, **Telegram.Bot 22.8.1**, ASP.NET Core (webhook), Flyway, Docker.
Тесты: Testcontainers (Postgres + Flyway + бот + FakeTgApi), отдельный OCR-suite (без Docker) + кеш.

---

## Ключевая логика

### Сообщение «Ты взял купон» (handleTake)

При взятии купона (команда `/take`, кнопка «Взять N» или `take:{id}`) бот шлёт **одно** сообщение:

- **SendPhoto** с `caption` и `replyMarkup` (не SendPhoto + отдельный SendMessage).
- Caption: `Ты взял купон {id}: {v} EUR, истекает {d}`.
- Кнопки: «Вернуть», «Использован» — `singleTakenKeyboard(coupon)`.
- Callback: `return:{id}:del` и `used:{id}:del`. Суффикс **`:del`** = при успешном действии удалять **это** сообщение (`DeleteMessage`), чтобы в чате не оставалось ни фото, ни кнопок.

### Команда /my (handleMy)

- Показываем **только «Мои взятые»** (не «Мои добавленные»).
- Список строится из `GetCouponsTakenBy`; под каждым купоном — кнопки «Вернуть» и «Использован».
- Callback: `return:{id}` и `used:{id}` **без** `:del` — сообщение не удаляем (список может содержать несколько купонов).

### Обработка callback (return / used)

- `return:{id}` или `return:{id}:del` — `handleReturn`; при `:del` и успехе (`ok`) — `DeleteMessage(cq.Message)` в `try/with`.
- `used:{id}` или `used:{id}:del` — `handleUsed`; при `:del` и успехе — `DeleteMessage(cq.Message)` в `try/with`.
- Парсинг: `deleteOnSuccess = cq.Data.EndsWith(":del")`, для извлечения `id` отрезать `:del` и взять число после `return:` / `used:`.
- `handleReturn` и `handleUsed` возвращают `bool` (успех операции), чтобы callback решал, вызывать ли `DeleteMessage`.

### Устаревшие кнопки (stale callbacks)

Кнопки остаются на сообщениях. Возможны нажатия по «старым» данным.
В этих случаях `handleReturn` / `handleUsed` дают `false`, бот отвечает «Не получилось... Убедись что он взят тобой», **DeleteMessage не вызывается**.

### GetCouponsTakenBy (DbService)

- Обязательно: `WHERE taken_by = @user_id AND status = 'taken'`.

---

## /add wizard + OCR (важно для UX и тестов)

### Общий принцип

- `CouponOcrEngine` делает barcode + Azure text OCR и возвращает `CouponOCR` как “есть значение / нет значения”.
- **Любой результат OCR — это лишь предзаполнение**: пользователь всё равно подтверждает финальные значения перед `AddCoupon`.

### Стадии wizard (PendingAddFlow.stage)

Базовые:
- `awaiting_photo`
- `awaiting_discount_choice` / `awaiting_discount_custom`
- `awaiting_date_choice` / `awaiting_date_custom`
- `awaiting_confirm`

OCR-ветка:
- `awaiting_ocr_confirm` — когда OCR распознал value + min_check + expires_at и просим “Да/Нет”.

### Partial OCR (обязательное поведение)

Если OCR распознал частично, **не откатываться “в ноль”**, а продолжать с первого недостающего шага, сохранив то, что нашли:

- распознаны `value` и `min_check`, но нет `expires_at` → перейти в `awaiting_date_choice` (пользователь выбирает дату).
- распознана только `expires_at` → сохранить её, перейти в `awaiting_discount_choice`; после выбора скидки/чека можно сразу перейти в `awaiting_confirm`.
- `barcode_text` опционален и **никогда не блокирует** добавление.

### Callback-префиксы в /add wizard

- `addflow:disc:<value>:<min_check>` — выбрать скидку и мин. чек.
- `addflow:disc:other` — перейти в ввод “вручную”.
- `addflow:date:today|tomorrow|other` — выбрать дату.
- `addflow:ocr:yes|no` — подтвердить/отклонить OCR-предзаполнение (актуально только для `awaiting_ocr_confirm`).
- `addflow:confirm` — создать купон.
- `addflow:cancel` — отмена wizard.

---

## Тесты

### Docker suite (Testcontainers)

- Поднимаются: Postgres, Flyway, бот, FakeTgApi.
- Для OCR e2e тестов дополнительно поднимается FakeAzureOcrApi и включается OCR в контейнере бота.

### FakeTgApi (фейки Telegram API)

- Логирует вызовы в `Store.calls` (Method, Url, Body, Timestamp).
- Реализованы `sendMessage`, `sendPhoto`, `sendMediaGroup`, `forwardMessage`, `answerCallbackQuery`, `getChatMember`, `getFile`, `deleteMessage`.

#### Файлы (DownloadFile) — важно для ZXing

Чтобы бот реально скачал фото байтами (а не “путь как строку”):
- `POST /test/mock/file` с `{ fileId, contentBase64 }` кладёт реальные байты в `Store.files`.
- `getFile` возвращает `file_path = photos/{fileId}.jpg`.
- `GET /file/bot{token}/photos/{fileId}.jpg` отдаёт **эти байты**.

### FakeAzureOcrApi (фейк Azure CV)

- Endpoint, который дергает `AzureOcrService`:
  - `POST /computervision/imageanalysis:analyze?overload=stream&api-version=2024-02-01&features=read`
- Test endpoints:
  - `POST /test/mock/response` с `{ status, body }` — подменить ответ (обычно берём `body` из `tests/CouponHubBot.Ocr.Tests/AzureCache/*.azure.json`).
  - `GET /test/calls` / `DELETE /test/calls` — дебаг.

### Отдельный OCR-suite (без Docker)

- `tests/CouponHubBot.Ocr.Tests` — проверяет `CouponOcrEngine` по изображениям из `Images/`.
- Azure text OCR кешируется в `AzureCache/` (git-tracked) и может работать cache-only.

---

## Миграции и права (GRANT)

- При добавлении **новой таблицы**/изменениях доступа в `src/migrations/` держать в голове GRANT для роли `coupon_hub_bot_service`.

---

## Windows / PowerShell заметки

- В PowerShell не использовать bash-heredoc (`cat <<EOF`) и `&&` в цепочках.
- Для команд git/dotnet — использовать `;` или отдельные команды.
